
### 因 KVO 监测 AVPlayerItem 的 playbackLikelyToKeepUp 值引起的闪退问题

#### 环境参数：

```
	iOS 10
```

#### 问题分析：

该值是检测 `Item` 是否缓冲到足够可以播放的状态
原本是使用 `KVO` 检测该值变化，需要在对象销毁之前释放 `KVO` 的监听，否则就会导致闪退。
然而释放逻辑在 `iOS 11` 和 `iOS 12` 上是正常释放没有问题的，但是在 `iOS 10` 上却出现了闪退问题。
经过一层一层的检测，有多个原因均可能导致该值无法正常释放。

```
1、由于释放操作是在播放新的 Item 前对旧的 Item 做的操作，然而因为原本因为播放列表的同步问题添加了一个全局通知，该通知会将 Item 清空，这里有个时序性的问题，有可能是因为在 Item 的观察值释放前，该 Item 被提前销毁了。
2、释放操作可能被其他 Item 替换了，导致释放的不是应该释放的 Item。
3、其他原因
```

#### 解决方法：
由于该问题仅在 `iOS 10` 下出现，我们又没有 `iOS 10` 的测试机，于是只能去下一个 `iOS 10` 版本的模拟器，经过漫长的等待，终于下载完成。

首先该问题出现的系统特殊，于是比较了下 `iOS 10` 和 `iOS 12` 之间该值的变化，很奇怪的是，在 `iOS 10` 下走到释放的方法时，该值已经被销毁了，所以释放操作无效。而在 `iOS 12` 下，该值并没有被销毁，从而正确被释放。这可能是由于 `AVPlayerItem` 内部一些实现的问题，会出现延迟释放。

那么解决办法就是，在释放的时候通知 `Item` 自身去移除 `Player` 的监听就好了，于是创建了一个分类，在分类的 `dealloc` 操作里移除 `Player` 的监听，闪退问题解决了，但是引起了另一个问题，就是播放器不能自动播放了。原本在监听操作里会做很多 `UI` 相关或者播放相关的工作，不能自动播放的原因是因为多收到了一条停止播放的通知，之后就无法自动播放了，解决办法是加多一条播放通知。